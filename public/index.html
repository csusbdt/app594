<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>App 594</title>
  </head>
  <body>
    <div id="fb-root"></div>
    
    <div class="view" id="updating-view" style="display: none">
      <div>Updating...</div>
    </div>
    
    <div class="view" id="error-view" style="display: none">
      <div id="error">Error</div>
    </div>
    
    <div class="view" id="login-view" style="display: none">
      <button id="login-btn">Login</button>
    </div>
    
    <div class="view" id="game-view" style="display: none">
      <div>Game on.</div>
    </div>
    
    <script src="js/jquery-1.8.3.min.js"></script>
    <script>
			var app = {};
			// cb = function(err)
			app.login = function(uid, accessToken, cb) {
				alert('establish session with server');
				cb();
			};
			// cb = function(err)
			app.getNumber = function(cb) {
				alert('use ajax to get number from server');
				app.number = 13;
				cb();
			};      
			app.saveNumber = function(number, cb) {
				alert('use ajax to save number through server');
				cb();
			};
      
      $(function() {
        function login() {
          // TODO: send accessToken to login; get success reply.
          FB.login(function(response) {
            if (response.authResponse) {
              FB.api('/me', function(response) {
                $('#login').hide();
                $('#msg').html('Hello, ' + response.name + '.');
              });
            } else {
                $('#msg').html('Authorization cancelled.');
            }
          });
        }

        window.fbAsyncInit = function() {
          FB.init({
            appId      : '<%= appId %>',
            channelUrl : '://' + window.location.host + '/channel.html',
            status     : true,   // Check the login status upon init?
            cookie     : false,  // Set session cookies?
            xfbml      : false   // Parse XFBML tags?
          });
          FB.getLoginStatus(function(response) {
            if (response.status === 'connected') {
              app.login(response.authResponse.userID, response.authResponse.accessToken, function(err) {
                if (err) {
                  $('#error').html(err);
                  $('#error-view').show();
                } else {
                  app.getNumber(function(err) {
                    if (err) {
                      $('#error').html(err);
                      $('#error-view').show();
                    } else {
                      $('.view').hide();
                      $('#game-view').show();
                    }
                  });
                }
              });
            } else {
              $('.view').hide();
              $('#login-btn').click(login);
              $('#login-view').show();
            }
          });
        };
        
        function asyncLoadSdk(){
          var js = document.createElement('script');
          var id = 'facebook-jssdk';
          var ref = document.getElementsByTagName('script')[0];
          if (document.getElementById(id)) {
            return;
          }
          js.id = id; 
          js.async = true;
          js.src = "//connect.facebook.net/en_US/all.js";
          ref.parentNode.insertBefore(js, ref);
        }
      
        if ('<%= appId %>' === '\<%= appId %>') {
          // Page loaded through file system.
          $('#game-view').show();
        } else {
          // Page loaded through server.
          $('#updating-view').show();
          asyncLoadSdk();
        }
      });
    </script>

  </body>
</html>
