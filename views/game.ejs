<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>App 594</title>
  </head>
  <body>
    <div id="fb-root"></div>
    
    <div id="updating-view">
      <div>Updating...</div>
    </div>
    
    <div id="error-view" style="display: none">
      <div id="error">Error</div>
    </div>
    
    <div id="login-view" style="display: none">
      <div id="login-msg"></div>
      <!--button id="login-btn">Login</button-->
    </div>
    
    <div id="game-view" style="display: none">
      <div id="number"></div>
      <button id="increment-btn">Increment</button>
      <button id="save-btn" style="display: none">Save</button>
    </div>
    
    <script src="js/jquery-1.8.3.min.js"></script>
    <script>
      // unless otherwise specified, cb = function(err)

      // define a global app object that functions as a controller
      var app = {};

      // define app.setView
      (function() {
        var currentView = 'updating-view';
        app.setView = function(view) {
          if (view == currentView) return;
          $('#' + currentView).hide();
          $('#' + view).show();
          currentView = view;
        }
      })();
      
      app.uid = null;
      app.accessToken = null;
      app.number = 0;

      app.login = function(args) {
        app.uid = args.uid;
        app.accessToken = args.accessToken;
        app.setView('updating-view');
        $.ajax({
          url: '/op/login',
          data: {
            uid: app.uid,
            accessToken: app.accessToken
          }
        })
        .done(function(data) {
          if (data.err) {
            $('#error').html(data.err);
            app.setView('error-view');
          } else {
            app.accessToken = data.accessToken;  // store new access_token
            app.getNumber();  // NOTE: To save a round trip, the server 
                              // could return number with the new access token.
          }
        })
        .fail(function(jqXHR, textStatus) {
          console.log('textStatus: ' + textStatus);
          console.log(jqXHR);
          $('#error').html(textStatus);
          app.setView('error-view');
        });
      };

      app.facebookLogin = function() {
        $('#login-msg').html('user did not login or did not authorize app');
        app.setView('login-view');
      };

      app.getNumber = function() {
        app.setView('updating-view');
        $.ajax({
          url: '/op/get-number',
          data: {
            accessToken: app.accessToken
          }
        })
        .done(function(data) {
          if (data.err) {
            $('#error').html(data.err);
            app.setView('error-view');
          } else {
            $('#number').html(data.number);
            app.setView('game-view');
          }
        })
        .fail(function(jqXHR, textStatus) {
          console.log('textStatus: ' + textStatus);
          console.log(jqXHR);
          $('#error').html(textStatus);
          app.setView('error-view');
        });
      };
      
      app.saveNumber = function() {
        app.setView('updating-view');
        $.ajax({
          url: '/op/save-number',
          data: {
            accessToken: app.accessToken,
            number: app.number
          }
        })
        .done(function(data) {
          if (data.err) {
            $('#error').html(data.err);
            app.setView('error-view');
          } else {
            $('#number').html(app.number);
            app.setView('game-view');
          }
        })
        .fail(function(jqXHR, textStatus) {
          console.log('textStatus: ' + textStatus);
          console.log(jqXHR);
          $('#error').html(textStatus);
          app.setView('error-view');
        });
      };
      
      // initialization
      $(function() {
        function asyncLoadSdk(){
          var js = document.createElement('script');
          var id = 'facebook-jssdk';
          var ref = document.getElementsByTagName('script')[0];
          if (document.getElementById(id)) {
            return;
          }
          js.id = id; 
          js.async = true;
          js.src = "//connect.facebook.net/en_US/all.js";
          ref.parentNode.insertBefore(js, ref);
        }
      
        window.fbAsyncInit = function() {        
          var loginTimeout;
          FB.init({
            appId      : '<%= appId %>',
            channelUrl : '://' + window.location.host + '/channel.html',
            status     : true,   // Check the login status upon init?
            cookie     : false,  // Set session cookies?
            xfbml      : false   // Parse XFBML tags?
          });
          function loginFacebook() {
            console.log("loginFacebook called");
            FB.getLoginStatus(function(response) {
              console.log("getLoginStatus callback called");
              if (response.status === 'connected') {
                console.log("connected to facebook");
                app.login({ uid: response.authResponse.userID, accessToken: response.authResponse.accessToken });
              } else {
                console.log("user did not login or did not authorize app");
                app.facebookLogin();
              }
            });
          }
          loginTimeout = setTimeout(loginFacebook, 1000);
          FB.Event.subscribe('auth.login', function(response) {
            console.log('auth.login fired');
            if (response.status === 'connected') {
              clearTimeout(loginTimeout);
              console.log("connected to facebook");
              app.login(response.authResponse.userID, response.authResponse.accessToken);
            } else {
              console.log("user did not login or did not authorize app");
            }
          });
          FB.Canvas.setAutoGrow();
        };

				$.ajaxSetup({
					global: false,
					type: "POST",
					dataType: 'json',
					cache: false  // appends a timstamp onto urls to bust caching, needed for iOS
				});
				
				$('#increment-btn').click(function() {
				  ++app.number;
				  $('#number').html('' + app.number);
				  $('#save-btn').show();
				});
				
				$('#save-btn').click(function() {
				  $('#save-btn').hide();				  
				  app.saveNumber();
				});
				
        if ('<%= appId %>' === '\<%= appId %>') {
          $('#error').html('Page loaded through file system.');
          app.setView('error-view');
        } else {
          // Page loaded through server.
          app.setView('updating-view');
          asyncLoadSdk();
        }
      });
    </script>

  </body>
</html>
