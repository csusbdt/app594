<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>App 594</title>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
  </head>
  <body>
    <div id="fb-root"></div>

    <div id="updating-view" style="display: none">
      <div>Updating...</div>
    </div>
    
    <div id="error-view" style="display: none">
      <div id="error">Error</div>
    </div>
    
    <div id="game-view">
      <div id="number"></div>
      <button id="increment-btn">Increment</button>
      <button id="save-btn" style="display: none">Save</button>
      
      <div>
        <img id="picture" />
      </div>
    </div>
    
    <div>
      This app is deployed on a free-tier dyno, 
      so there will be a long delay when loading the page
      if the server needs to start up.  The app will idle
      after one hour of inactivity.
    </div>
    
    <div>
      Need to add code to re-auth with Facebook if secret is bad on save operation.
    </div>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
    <script>
      var app = <%- app %>;

      // define app.setView
      (function() {
        var currentView = 'updating-view';
        app.setView = function(view) {
          if (view == currentView) return;
          $('#' + currentView).hide();
          $('#' + view).show();
          currentView = view;
        }
      })();

      app.saveNumber = function() {
        app.setView('updating-view');
        $.ajax({
          url: '/save',
          data: JSON.stringify({
            uid: app.uid,
            secret: app.secret,
            gameState: app.gameState
          })
        })
        .done(function(data) {
          if (data.error) {
            $('#error').html(data.error);
            app.setView('error-view');
          } else if (data.login) {
            $('#error').html('need to login into facebook again');
            app.setView('error-view');
          } else {
            $('#number').html(app.gameState.number);
            app.setView('game-view');
          }
        })
        .fail(function(jqXHR, textStatus) {
          console.log('textStatus: ' + textStatus);
          console.log(jqXHR);
          $('#error').html(textStatus);
          app.setView('error-view');
        });
      };

      $(function() {
				$.ajaxSetup({
					global: false,
					type: "POST",
					dataType: 'json',
					contentType: 'application/json; charset=utf-8',
					cache: false 
				});
				
				$('#number').html(app.gameState.number);
        
        $('#increment-btn').click(function() {
          ++app.gameState.number;
          $('#number').html('' + app.gameState.number);
          $('#save-btn').show();
        });
        
        $('#save-btn').click(function() {
          $('#save-btn').hide();				  
          app.saveNumber();
        });
        
        $('#picture').attr('src', 'http://graph.facebook.com/' + app.uid + '/picture?type=normal');
      });
    </script>

  </body>
</html>
